http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;
  sendfile      on;
  keepalive_timeout 65;

  limit_req_zone $binary_remote_addr zone=bot:10m rate=5r/s;
  limit_req_status 429;

  map $http_user_agent $bad_ua {
    default 0;
    ~*libredtail-http 1;
  }

  upstream proj1_api   { server proj1-web:8000; }
  upstream proj1_front { server proj1-front:80; }
  upstream proj2_api   { server proj2-web:8000; }
  upstream proj2_front { server proj2-front:80; }

  # ---------- HTTP tehnodel.ru: редирект на HTTPS ----------
  server {
    listen 80;
    server_name tehnodel.ru;
    return 301 https://$host$request_uri;
  }

  # ---------- HTTPS tehnodel.ru (proj1) ----------
  server {
    listen 443 ssl;         # http2 лучше вынести отдельной директивой
    http2 on;
    server_name tehnodel.ru;
    client_max_body_size 64M;

    ssl_certificate     /etc/nginx/ssl/tehnodel.ru.fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/tehnodel.ru.key;
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:10m;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    location ~* \.(php|phar|phtml)$ { return 444; }
    location ~* ^/(vendor|tests?|backup|public|lib|app|cms|blog|workspace|yii|zend|laravel|phpunit)(/|$) { return 444; }
    if ($bad_ua) { return 403; }

    location /back_media/ {
      alias /media/proj1/;
      access_log off; expires 30d; add_header Cache-Control "public";
      try_files $uri =404;
    }

    location /back_static/ {
      alias /static/proj1/;
      access_log off; expires 30d; add_header Cache-Control "public";
      try_files $uri =404;
    }

    location ~ ^/(back_static|back_media)/(.+\.(?:css|js|png|jpe?g|svg|gif|webp|ico|woff2?|ttf|map))/$ {
      return 301 /$1/$2;
    }

    location ~ ^/(api/|admin/) {
      limit_req zone=bot burst=20 nodelay;
      proxy_pass http://proj1_api;      # <= http!
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_http_version 1.1;
      proxy_redirect off;
      proxy_read_timeout 60s;
    }

    location / {
      proxy_pass http://proj1_front;    # <= http!
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_http_version 1.1;
      proxy_redirect off;
      proxy_read_timeout 60s;
    }
  }

  # ---------- HTTP tehnodel.kg: ACME + redirect ----------
  server {
    listen 80;
    server_name tehnodel.kg www.tehnodel.kg;

    # webroot для certbot (чтобы выпустить/продлить сертификат)
    location /.well-known/acme-challenge/ {
      alias /var/www/certbot/.well-known/acme-challenge/;
      access_log off;
    }

    return 301 https://$host$request_uri;
  }

  # ---------- HTTPS tehnodel.kg (proj2) ----------
  server {
    listen 443 ssl;
    http2 on;
    server_name tehnodel.kg www.tehnodel.kg;
    client_max_body_size 64M;

    # Появятся после certbot:
    ssl_certificate     /etc/letsencrypt/live/tehnodel.kg/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/tehnodel.kg/privkey.pem;
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:10m;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    location ~* \.(php|phar|phtml)$ { return 444; }
    location ~* ^/(vendor|tests?|backup|public|lib|app|cms|blog|workspace|yii|zend|laravel|phpunit)(/|$) { return 444; }
    if ($bad_ua) { return 403; }

    location /back_media/ {
      alias /media/proj2/; access_log off; expires 30d; add_header Cache-Control "public";
      try_files $uri =404;
    }

    location /back_static/ {
      alias /static/proj2/; access_log off; expires 30d; add_header Cache-Control "public";
      try_files $uri =404;
    }

    location ~ ^/(back_static|back_media)/(.+\.(?:css|js|png|jpe?g|svg|gif|webp|ico|woff2?|ttf|map))/$ {
      return 301 /$1/$2;
    }

    location ~ ^/(api/|admin/) {
      limit_req zone=bot burst=20 nodelay;
      proxy_pass http://proj2_api;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_http_version 1.1;
      proxy_redirect off;
      proxy_read_timeout 60s;
    }

    location / {
      proxy_pass http://proj2_front;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_http_version 1.1;
      proxy_redirect off;
      proxy_read_timeout 60s;
    }
  }
}
